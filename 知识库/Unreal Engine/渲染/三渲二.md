# 仿原神

根据模型定制 Shader, 注意模型拆分

**头发**

**脸 For 变形**

**眉毛 For 透视**

**睫毛 For 透视**

## 贴图准备

**非漫反射关闭 SRGB/漫反射开启 SRGB SDF 贴图改为灰度 a 关闭压缩**

|   |   |   |   |   |
|---|---|---|---|---|
|图片|贴图||||
|![[Pasted image 20250426104025.png]]|SDF|关闭压缩, 不然锯齿感很强|||
|![[Pasted image 20250426104037.png]]|面部阴影遮罩||||
|![[Pasted image 20250426104050.png]]|金属 MatCap||||
|![[Pasted image 20250426104101.png]]|漫反射贴图<br><br>(Diffuse)||||
|![[Pasted image 20250426104111.png]]|LightMap||||
|![[Pasted image 20250426104122.png]]|法线图<br><br>(NormMap)|类型改为法线贴图|在虚幻里面, 类型为法线贴图会丢失内描边信息, 可以自己解压缩<br><br>检查 G 通道是否需要反转||
|![[Pasted image 20250426104130.png]]|Ramp 图||||
|![[Pasted image 20250426104138.png]]|高光 Ramp 图||||

## 获取上下文 (需要用到的向量等数据)

### 法线贴图

**可以之间设置贴图为法线贴图, 然后使用解析器直接使用.**

由于 Genshin 在法线贴图中包含了**内描边信息**, 所有需要使用线性颜色解析器, 手动构造法线贴图, 然后提取出所需要的内描边信息.**(压缩改为 BC7，关闭 SRGB)**

![[Pasted image 20250426104221.png]]

以上就能获取到能够使用的 Norm 信息, 如果没有 NormMap 则需要使用 `世界空间顶点法线` 这个节点

由于 `世界空间顶点法线` 节点输出就是世界空间信息, 所有不需要转化, 最多使用 `规格化` 一次.

**参考:**

- 法线贴图用 RGB 颜色标记法线方向 (XYZ)
    
- 以 3DS MAX 坐标系为例，说明切线算法依据，建立紧贴平面的法线坐标，其与位图关系为 **pixel=（normal+1）/2**，模型法线方向大多为 Z 轴（0，0，1），映射到颜色空间是（0.5，0.5，1），呈蓝紫色.
    
- Tangent 切线空间：基于每个面的切线方向，最常见，多为浅蓝紫色，B 通道表示法线方向斜率，R 通道表示左右切线方向斜率，G 通道表示切线方向向上或向下斜率。
    
- Object 对象空间：基于整个对象，多为五颜六色，渲染较快，但在对称模型上浪费纹理空间且无法进行 UV 动画，切线空间通常更优。
    
- World 世界空间：基于全局坐标，最不灵活，常用于大型、静态和非对称物体或计算特殊效果。

综上所述, 所以需要进行**（normal+1）/2**的逆运算.再 `转换到世界空间`, 最后进行 `规格化`

**Tips:**

原神的法线贴图在 UE 中需要**翻转 G 通道.**

### NoL(Lambert/兰伯特)

**N: Norm(顶点的法线向量)**

**L: Light(主光源的光线向量)**

Lambertian 漫反射中的 NoL（Normal dot(点积) Light)

Dot 的数学原理请百度

**作用**: 衡量表面法线和光线方向之间的夹角关系

**光线与法线同向为 1, 垂直为 0, 相反为 -1**

**说明:** NoL 的值越大，说明光线与物体表面的法线方向越接近，物体表面接收到的光照强度就越高，相应的该部分表面就会显得更亮。

### NoH(~~半角向量~~/~~高光向量~~)

**N: Norm(顶点的法线向量)**

**H: Halfway Vector(Light+CameraV(摄像机向量))**

  **L+V=H**

  H 是半角向量 (Half - Angle Vector)，其中 V 是视线方向向量 (ViewDirectionVector)**(UE 中是 CameraV)**，用于表示从观察点 (如摄像机位置）指向物体表面的方向。**半角向量 H 大致位于光线方向向量 L 和视线方向向量 V 的中间位置**，其作用是衡量视线方向与光线反射方向（在理想镜面反射情况下）的接近程度。

NoH 主要用于计算物体表面的**高光反射（Specular Highlights）部分**。

当光线照射到物体表面时，在光滑的表面上会产生高光反射现象。"N・H" 的值可以衡量半角向量与物体表面法线的接近程度，其值越大，高光反射就越强，物体表面的亮点就越明显。

在一些光照模型中，如 **Blinn-Phong 光照模型**，就是利用 "N・H" 的结果来计算高光反射的强度，从而使渲染出的物体更加逼真

### NoV(Fresnel/菲涅尔)

**N: Norm(顶点的法线向量)**

V: **CameraVector(摄像机向量)**

NoV（更准确地说是 N・V）代表表面法线向量（N）和视线方向向量（V）的点积（Dot Product）

在菲涅尔反射计算中，反射率会随着观察角度（也就是视线方向与表面法线方向的夹角）的变化而变化。例如，在 Schlick 近似公式 F = F₀+(1 - F₀)(1 - (N・V))⁵中，N・V 用于衡量观察角度对反射率 F 的影响。当视线垂直于表面（N・V = 1）时，反射率接近基础反射率 F₀；随着视线方向与表面法线夹角增大（N・V 减小），反射率会逐渐增大，这符合菲涅尔效应中反射光比例随观察角度增大而增大的物理现象

5. ### MatcapUV(用于采样高光 Tex 的 UV)

MatcapUV(用于采样高光 Tex 的 UV)

**作用:** 用于采样贴图的 UV 数据

MatcapUV = TransferToWord (N) * (0.5, -0.5) + (0.5, 0.5)

当使用 Matcap 技术时，模型的每个点都需要根据其在场景中的朝向（法线方向）来获取 Matcap 纹理上对应的颜色。MatcapUV 就是用来确定这个对应关系的坐标。 一般情况下，会通过将模型的法线方向转换为 UV 坐标空间来获取 MatcapUV。例如，假设模型的某个点的法线方向为，通过一定的转换算法（可能因软件或引擎而异），将这个法线方向转换为在 Matcap 纹理上的坐标，这个坐标就是 MatcapUV。 以一个简单的球体模型为例，球体表面不同点的法线方向不同。通过计算每个点的法线方向对应的 MatcapUV，就可以从 Matcap 纹理中获取相应的颜色，从而让球体看起来像是具有特定材质的外观，比如金属质感、塑料质感等，而且这个过程不需要复杂的光照计算和材质模型搭建。

## BaseColor(基础漫反射颜色)

**沿用 MMD 的调色方案, 预设一些参数用于调色**

**BaseTex, ToonTex, SphereTex**

![[Pasted image 20250426104257.png]]

从**环境光颜色 + 漫反射颜色**为基础, 逐步混合 BaseTex, ToonTex, SphereTex, 再加上内描边信息和控制色调映.

最终获得 BaseColorRGB

![[Pasted image 20250426104304.png]]

## LightMap(光照贴图)

### R 通道

**控制高光强度**

灰度是对高光的枚举值

从 0~1.0 Step=0.1

1.0 是金属, 小于 1.0 是非金属

非金属的灰度值可直接作为高光强度

### G 通道

**控制光照**

类似 AO

**灰度值 = 0 : 完全不受光源影响, 常暗**

**灰度值 = 0.5 : 受光源影响, 有光就亮, 无光就暗**

**灰度值 = 1 : 完全不受光源影响, 常亮**

### B 通道

**控制高光形状 (细节)**

### A 通道

**控制采样 Ramp 图**

**灰度值: 代表材质的枚举.**

|   |   |   |   |   |   |
|---|---|---|---|---|---|
|ILM.a 通道灰度值|0|0.3|0.5|0.7|1|
|Ramp 图|硬物体|软物体|金属 (投影)|丝绸 (丝袜)|皮肤 (头发)|
|Ramp 图|第 1 行|第 4 行|第 3 行|第 5 行|第 2 行|

使用 A 通道灰度值采样 Ramp 的对应行数, 然后进行混合

#### Ramp 图 (采样 Ramp)

Ramp 图有 10 行，**上 5 行/暖的是白天的**，**下 5 行/冷的是夜晚的**

**因为贴图的数据是输入来源, 所有需要根据贴图 A 通道使用 Step 逐步判断.**

**相当于将 RGB.a 的灰度值映射到 Ramp 的 V 上**

例如从贴图数据 0~1 开始, 所以需要从 0~1 开始判断

$$
\text{Step}(Y, X) = 
\begin{cases} 
0 & \text{if } X < Y \\
1 & \text{if} X >= Y \\
\end{cases}
$$

相当于, 输入端 A 根据通过黑盒 输出对应映射 RampV

转换方法多种多样, 使用正片叠底也行

5. ## 高光

6. ## Outline(描边线)

**内描边:** 在 Genshin 中, 是通过法线贴图传递信息.

**外描边:**

![[Pasted image 20250426104652.png]]

**在虚幻里面使用模型描边线 (在 DDC 软件内描边导出)**

优点: 支持动画, 物理, (不支持动画)

1. 选中顶点到材质
    
2. 按距离合并顶点 (有可能会影响顶点连在一起)
    
3. 将顶点沿着法线偏移
    
4. 翻转法线

5. ## SDF 面部

使用 SDF 灰度图控制面部阴影

通过蓝图传入面部朝向向量在 SDF 中取阈值, 然后应用在面部材质中
